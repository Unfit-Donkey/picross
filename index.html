<html>

    <body>

    </body>

    <head>
        <script src="src/compiled/picrossCpp.js"></script>
        <script src="src/voxelviewer.js" type="module"></script>
        <script src="src/documentManager.js"></script>
        <link rel="stylesheet" href="page/style.css" type="text/css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <canvas width="50" height="50" id="textRender" style="display:none"></canvas>
    <!-- Slicer -->
    <div id="slicer">
    </div>
    <!-- Action buttons -->
    <div class="option_buttons_holder" id="puzzle_viewer">
        <button class="option_button" onclick="showPopup('shortcuts_popup')">Shortcuts</button>
        <button class="option_button" onclick="showPopup('main_menu')"><u>E</u>xit</button>

        <div class="sandbox">
            <button class="option_button" onclick="copyPuzzle()">Cop<u>y</u></button>
            <button class="option_button" onclick="pastePuzzle()"><u>P</u>aste</button>
        </div>
        <div class="creator">
            <button class="option_button"><u>F</u>inish puzzle</button>
        </div>
        <div class="player">
            <button class="option_button">Des<u>t</u>roy zeroes</button>
        </div>
        <div class="solver">
            <button class="option_button" onclick="solveCurrentPuzzle()">S<u>o</u>lve</button>
        </div>
    </div>
    <!-- Menus -->
    <div id="popup_box">
        <button tabindex="1" id="popup_close" onclick="hide('popup_box');hide('popup_background');">x</button>
        <div class="popup_page" id="main_menu" style="display:block">
            <button onclick="openGameMode('player');" tabindex="2">Play puzzle</button>
            <button onclick="openGameMode('creator');" tabindex="3">Create puzzle</button>
            <button onclick="openGameMode('solver');" tabindex="4">Solve puzzle</button>
            <button onclick="openGameMode('sandbox');" tabindex="5">Sandbox</button>
            <button onclick="showPopup('guide_popup')" tabindex="6">Guide/Info</button>
            <button onclick="showPopup('settings')" tabindex="7">Settings</button>
        </div>
        <div class="popup_page creator solver" id="puzzle_creator_popup">
            <div class="creator sandbox">
                <label for="puzzle_data">Duplicate from text:</label><input type="text" id="puzzle_data"
                       placeholder="eJxzSizOTFYoKK2qykmtM67z9XCr09YdB" tabindex="101">
                <br><br>
                OR
                <br><br>
                <label for="puzzle_name">Name: </label><input type="text" id="puzzle_name" placeholder="Basic puzzle"
                       tabindex="102"><br>
            </div>
            <label for="puzzle_dimension">Dimension: </label><input type="number" min="1" placeholder="3" max="10"
                   oninput="updateAxisSizeList(this.value);" id="puzzle_dimension" tabindex="105"><br>
            Axis size:
            <ol id="axis_size_list">
            </ol>
            <br>
            <button onclick="createPuzzle()" tabindex="130">Go!</button>
            <div id="create_puzzle_error"></div>
            <script>
                function updateAxisSizeList(dim) {
                    dim = Math.min(dim, 10);
                    let text = "";
                    for(let i = 0; i < dim; i++) {
                        text += "<li><input type='number' min='1' max='32' placeholder='4' tabindex='" + (110 + i) + "'></li>";
                    }
                    fromId("axis_size_list").innerHTML = text;
                }
                function createPuzzle() {
                    const errorOutput = fromId("create_puzzle_error");
                    if(document.getElementById("puzzle_data").value != "") {
                        try {
                            fullPuzzle = Puzzle.fromBase64(document.getElementById("puzzle_data").value);
                        } catch(e) {
                            errorOutput.innerHTML = "Error: Invalid puzzle string (see console for details)";
                            throw e;
                        }
                    }
                    else {
                        let name = fromId("puzzle_name").value || "Basic Puzzle";
                        let dimension = Number(fromId("puzzle_dimension").value || 3);
                        if(dimension > 10 || dimension < 1) {
                            return errorOutput.innerHTML = "Error: Dimension must be between 1 and 10";
                        }
                        let axises = fromId("axis_size_list");
                        let size = [];
                        for(let i = 0; i < axises.children.length; i++) {
                            size[i] = Number(axises.children[i].children[0].value || 4);
                            if(size[i] < 1 || size[i] > 32) {
                                return errorOutput.innerHTML = "Error: Axis size must be between 1 and 32";
                            }
                        }
                        console.log("New puzzle: ", name, dimension, size);
                        fullPuzzle = new Puzzle(dimension, size, name);
                        fullPuzzle.shape.fill(3);
                        fullPuzzle.hintsTotal.fill(0);
                        fullPuzzle.hintsPieces.fill(0);
                    }
                    updateScene();
                    slices = new Array(fullPuzzle.dimension).fill(0);
                    slices[0] = -1;
                    slices[1] = -2;
                    slices[2] = -3;
                    generateSlicer();
                    hide("popup_box");
                    hide("popup_background");
                }
            </script>
        </div>
        <div class="popup_page" id="puzzle_data_enteror">
            Puzzle data:<br>
            <input type="text" placeholder="eJxzSizOTFYoKK2qykmtM67z9XCr09YdB" id="puzzle_player_data" tabindex="101">
            <button tabindex="102">Start!</button>
            <div id="puzzle_player_error"></div>
        </div>
        <div class="popup_page" id="shortcuts_popup">
            <div class="sandbox creator player">
                <p>Underlined characters in the upper-right buttons are their shortcut</p>
                <h3>Universal</h3>
                Ctrl+click Destroy block
                Shift+click Color block
                WASD Control slicer
                XYZ Set dimension
                Escape key Close menu
                E Exit
            </div>
            <div class="player">
                <h3>Player</h3>
                T Des<u>t</u>roy Zeroes
            </div>
            <div class="sandbox">
                <h3>Sandbox</h3>
                Y Cop<u>y</u>
                P Paste
            </div>
            <div class="creator">
                <h3>Creator</h3>
                F Finish puzzle
            </div>
            <div class="solver">
                <h3>Solver</h3>
                0-9 Set hint's total
                Shift+(1-9) Set hint's pieces
                + Increase hint total
                - Decrease hint total
                [ Increase hint pieces
                ] Decrease hint pieces
                O S<u>o</u>lve
            </div>
        </div>
        <div class="popup_page" id="metadata_popup">
            <label for="puzzle_name">Name: </label><input id="puzzle_name"
                   onchange="fullPuzzle.metadata.name=this.value"><br>
            <label for="puzzle_background">Background: </label><input id="puzzle_url" placeholder="https://"
                   onchange="fullPuzzle.metadata.background=this.value">
            <label for="puzzle_color">Paint color: </label><input id="puzzle_color" placeholder="hex or word"
                   onchange="fullPuzzle.metadata.color=convertColor(this.value);">
            <button onclick="copyPuzzle()">Copy puzzle</button>
        </div>
        <div class="popup_page" id="guide_popup">
        </div>
        <div class="popup_page" id="settings">

        </div>
        <script>
            function showPopup(id) {
                hideAll("popup_page");
                show(id);
                show("popup_background");
                show("popup_box");
            }

        </script>
    </div>
    <div id="popup_background"></div>
    <div style="display:none" id="clipboard"> </div>

</html>